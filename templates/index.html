<!DOCTYPE HTML>
<html>
<head>
    <style>

        html {
          height: 100%;
          padding: 0;
          margin: 0;
          font-family: helvetica, sans-serif;
        }

        body {
          background-color: rgb(230,230,230);
          padding: 0;
          margin: 0;
          height: 100%;
          color: #444;
        }

        div {
          box-sizing: border-box;
        }

        h1 {
          /*font-family: georgia, serif;*/
          font-style: italic;
          font-size: 24px;
          /*font-weight: 300;*/
          margin: 10px 0 10px;
        }

        .node {
          stroke: #fff;
          stroke-width: 1px;
        }

        .link {
          stroke: #666;
          stroke-opacity: .4;
        }

        .node.selected {
            stroke-width: 3px;
        }

        #timer {
          width: 100%;
        }

        .vis-wrapper {
          height: 100%;
          min-height: 800px;
          margin-left: 300px;
        }

        .vis-cover {
          z-index: 500;
          position: fixed;
          top: 0;
          bottom: 0;
          left: 0;
          right: 0;
          background-color: rgba(0,0,0,0.2);
          margin-left: 300px;
          pointer-events: none;
        }

        #vis {
          position: relative;
          width: 100%;
          height: 100%;
          min-height: 800px;
        }

        .sidebar {
          position: fixed;
          width: 300px;
          top: 0;
          bottom: 0;
          left: 0;
          background-color: rgb(240,240,240);
          -webkit-box-shadow: 2px 0px 5px 0px rgba(0,0,0,0.1);
          -moz-box-shadow: 2px 0px 5px 0px rgba(0,0,0,0.1);
          box-shadow: 2px 0px 5px 0px rgba(0,0,0,0.1);
          padding: 15px;
        }

        </style>
    <title> Ver 0.6.0-Beta </title>
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
    <script type="text/javascript" charset="utf-8">

        $(document).ready(function(){

            // Global dataset object
            var _dataset;

            namespace = '/test'; // change to an empty string to use the global namespace

            // the socket.io documentation recommends sending an explicit package upon connection
            // this is specially important when using the global namespace
            var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);

            socket.on('connect', function() {
            });

            // event handler for server sent data
            // the data is displayed in the "Received" section of the page
            socket.on('my response', function(data) {
                _dataset = JSON.parse(data.data);
                console.log(_dataset);
                initialize(_dataset);
                addNodesToMenu(_dataset.nodes);
                for (var i=0; i<100; i++) force.tick();
            });
            
            var width = $("#vis").width();
                height = $("#vis").height();

            var ocol = d3.scale.category20();
                
            var force = d3.layout.force()
                .charge(-170)
                .linkDistance(70)
                .size([width, height]);

            var svg = d3.select("#vis").append("svg")
                .attr("width", width)
                .attr("height", height);

            var stopRun = true;

            function initialize(graph) {

              force
                .nodes(graph.nodes)
                .links(graph.links)
                .start();

              var link = svg.selectAll(".link")
                .data(graph.links)
                .enter().append("line")
                  .attr("class", "link")
                  .style("stroke-width", function(d) { return Math.sqrt(d.value); });

              var node = svg.selectAll(".node")
                  .data(graph.nodes)
                  .enter().append("circle")
                  .attr("class", "node")
                  .attr("r", function(d) { return d.degree/20+4; })
                  .style("fill", function(d) { return ocol(d.group); })
                  .on("click", function(d) {
                    var curClass = d3.select(this).attr("class");
                    if (curClass.indexOf("selected") > -1) {
                      d3.select(this).attr("class","node");
                    } else {
                      d3.select(this).attr("class","node selected");
                    }
                    socket.emit("update", d.ind) // parameters
                  })
                  .call(force.drag);

              node.append("title")
                  .text(function(d) { return d.name; });

              force.on("tick", function() {
                link.attr("x1", function(d) { return d.source.x; })
                    .attr("y1", function(d) { return d.source.y; })
                    .attr("x2", function(d) { return d.target.x; })
                    .attr("y2", function(d) { return d.target.y; });

                node.attr("cx", function(d) { return d.x; })
                    .attr("cy", function(d) { return d.y; });

              });
                
             document.addEventListener("keydown", function(e) {
                if (e.keyCode === 13) {
                  force.stop()
                  stopRun = false;
                  socket.emit("startRun", 0.01, 1e-3);
                } else if (e.keyCode === 27) {
                  stopRun = true;
                }
             });

              // ms

              var framerate = 100;

              function update(arr) {

                for (var i=0; i<graph.nodes.length; i++) {
                  graph.nodes[i].voltage = arr[i]
                }
                
                svg.selectAll(".node")
                  .data(graph.nodes)
                  .transition()
                  .duration(framerate)
                  .attr("r", function(d) {
                    return Math.round(15*(Math.pow(d.voltage,2)/(1+Math.pow(d.voltage,2))));
                })
                
              } 
                
              socket.on('new data', function(data) {
                timesteps.push(data);
                console.log(0)
                var pause = timesteps.length > 18 ? 100 : 0
                setTimeout(function() {
                  if (!stopRun) socket.emit("continue run");
                }, pause);
                  
              });

              var timesteps = [];

              setInterval(function() {

                var str = "Buffer: " + timesteps.length + " ";

                if (!stopRun && timesteps.length < 1) {
                  str += "buffering";
                  $(".vis-cover").show()
                } else {
                  $(".vis-cover").hide()
                }

                $("#buffer").html(str);

                if (timesteps.length > 0) {
                    var timestep = timesteps.shift();
                    update(timestep);
                } 

               }, framerate);

            }

            function addNodesToMenu(nodes) {
              console.log(nodes);
            }

        });

    </script>
</head>
<body>

<!--   <div id="timer">
    Ver0.4-Beta
  </div> -->

  <div class="vis-wrapper">
    <div id="vis"></div>
  </div>

  <div class="sidebar">

    <h1>C.Elegens Dynome Ver 0.6.0-Beta</h1>

    <span id="buffer"></span>
  </div>

  <div class="vis-cover"></div>

</body>
</html>
